mod display;
mod http;
mod platform;
mod touch;
mod wifi;

use esp_idf_hal::peripherals::Peripherals;
use esp_idf_svc::eventloop::EspSystemEventLoop;
use esp_idf_svc::nvs::EspDefaultNvsPartition;
use esp_idf_sys as _;

use crate::display::DisplayLineBuffer;
use crate::platform::Esp32Platform;
use crate::touch::TouchController;

// Generated by slint-build from ui/badge.slint
slint::include_modules!();

fn main() -> anyhow::Result<()> {
    // Initialize ESP-IDF logging + system
    esp_idf_svc::log::EspLogger::initialize_default();
    log::info!("VRCBadge firmware starting");

    // Take hardware peripherals
    let peripherals = Peripherals::take()?;

    // --- WiFi AP + HTTP server ---
    let sys_loop = EspSystemEventLoop::take()?;
    let nvs_partition = EspDefaultNvsPartition::take()?;
    let _wifi = wifi::init(peripherals.modem, sys_loop, nvs_partition)?;
    let _server = http::init()?;

    // --- Slint platform ---
    let esp_platform = Esp32Platform::new();
    let window = esp_platform.window();
    slint::platform::set_platform(Box::new(esp_platform))
        .map_err(|e| anyhow::anyhow!("Failed to set Slint platform: {:?}", e))?;

    // --- Display (ST7796S over SPI) ---
    let mut display = display::init(
        peripherals.spi2,
        peripherals.pins.gpio12.into(), // SCLK
        peripherals.pins.gpio11.into(), // MOSI
        peripherals.pins.gpio10.into(), // CS
        peripherals.pins.gpio9.into(),  // DC
        peripherals.pins.gpio8.into(),  // RST
        peripherals.pins.gpio7.into(),  // BL
    )?;

    // --- Touch (GT911 over I2C) ---
    let mut touch = TouchController::new(
        peripherals.i2c0,
        peripherals.pins.gpio1.into(), // SDA
        peripherals.pins.gpio2.into(), // SCL
        peripherals.pins.gpio4.into(), // Touch RST
    )?;

    // --- Create UI ---
    let ui = BadgeUI::new().map_err(|e| anyhow::anyhow!("Failed to create UI: {:?}", e))?;

    // Set initial values
    ui.set_display_name("Hebu".into());
    ui.set_tagline("Hello from VRCBadge!".into());
    ui.set_twitter_handle("@Hebu_VRC".into());
    ui.set_discord_handle("hebu".into());
    ui.set_battery_percent(100);

    log::info!("UI initialized, entering main loop");

    // --- Main event loop ---
    loop {
        // 1. Process Slint timers and animations
        slint::platform::update_timers_and_animations();

        // 2. Poll touch input → dispatch events to Slint
        touch.poll(&window);

        // 3. Render display if needed
        window.draw_if_needed(|renderer| {
            renderer.render_by_line(DisplayLineBuffer::new(&mut display));
        });

        // 4. Sleep until next event needed
        if !window.has_active_animations() {
            if let Some(duration) = slint::platform::duration_until_next_timer_update() {
                // Sleep for at most the duration, but wake periodically for touch polling
                let sleep_ms = duration.as_millis().min(16) as u32; // Cap at ~60fps for touch
                esp_idf_hal::delay::FreeRtos::delay_ms(sleep_ms);
            } else {
                // No timers pending — sleep briefly for touch responsiveness
                esp_idf_hal::delay::FreeRtos::delay_ms(16);
            }
        }
    }
}
